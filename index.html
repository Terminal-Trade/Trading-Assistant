<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Trading Terminal</title>
<style>
body{font-family:sans-serif;background:#0a0a0a;color:#fff;margin:0;padding:0;}
.buy-control{cursor:pointer;padding:8px 12px;background:linear-gradient(90deg,#0ff,#f0f);border-radius:8px;color:#000;margin-top:10px;display:inline-block;}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);justify-content:center;align-items:center;z-index:1000;}
.modal.open{display:flex;}
.modal-content{background:#111;padding:20px;border-radius:8px;max-width:600px;width:90%;position:relative;}
.modal-close{position:absolute;top:10px;right:14px;cursor:pointer;color:#fff;font-size:18px;}
.download-box{margin-top:16px;padding:14px;background:rgba(255,255,255,0.05);border-radius:6px;display:none;}
</style>
</head>
<body>

<h1>Trading Terminal</h1>

<div>
  <div>
    <h3>Windows $35</h3>
    <a class="buy-control" data-product="product1">Buy</a>
  </div>
  <div>
    <h3>Linux $35</h3>
    <a class="buy-control" data-product="product2">Buy</a>
  </div>
  <div>
    <h3>Mac $35</h3>
    <a class="buy-control" data-product="product3">Buy</a>
  </div>
</div>

<div class="download-box" id="downloadBox">
  <p id="downloadMessage">Your download link:</p>
  <a id="downloadUrl" href="#" target="_blank" rel="noopener"></a>
</div>

<div class="modal" id="checkoutModal">
  <div class="modal-content">
    <span class="modal-close" id="closeModal">&times;</span>
    <p id="modalStatus">Preparing checkout...</p>
    <iframe id="checkoutIframe" src="" style="width:100%;height:500px;border:0;"></iframe>
  </div>
</div>

<script>
const SERVER_URL = 'https://trading-assistant-v6q5.onrender.com';
const buyButtons = document.querySelectorAll('.buy-control');
const checkoutModal = document.getElementById('checkoutModal');
const checkoutIframe = document.getElementById('checkoutIframe');
const closeModalBtn = document.getElementById('closeModal');
const modalStatus = document.getElementById('modalStatus');
const downloadBox = document.getElementById('downloadBox');
const downloadUrl = document.getElementById('downloadUrl');
const downloadMessage = document.getElementById('downloadMessage');

let pollIntervalId = null;
let pollingRunning = false;
let currentProduct = null;

closeModalBtn.addEventListener('click', () => { closeCheckoutModal(); });
checkoutModal.addEventListener('click', (e) => { if(e.target===checkoutModal) closeCheckoutModal(); });

function openCheckoutModal(url){
  checkoutIframe.src = url;
  checkoutModal.classList.add('open');
  modalStatus.textContent = 'Checkout open. Complete payment.';
}
function closeCheckoutModal(){
  checkoutModal.classList.remove('open');
  checkoutIframe.src = 'about:blank';
  stopPolling();
}

function startPolling(product){
  stopPolling();
  currentProduct = product;
  pollingRunning = true;
  pollIntervalId = setInterval(async()=>{
    try{
      const resp = await fetch(`${SERVER_URL}/download/${encodeURIComponent(product)}`);
      if(!resp.ok) return;
      const data = await resp.json();
      if(data && data.fileUrl){
        showDownloadLink(data.fileUrl);
        stopPolling();
        closeCheckoutModal();
      }
    }catch(err){ console.warn('Polling error:',err);}
  }, 3000);

  // Таймаут 20 минут
  setTimeout(()=>{
    if(pollingRunning){
      stopPolling();
      modalStatus.textContent = 'Timeout: download not available. Contact support.';
    }
  }, 20*60*1000);
}

function stopPolling(){ if(pollIntervalId) clearInterval(pollIntervalId); pollIntervalId=null; pollingRunning=false; }

function showDownloadLink(url){
  downloadUrl.href = url;
  downloadUrl.textContent = url;
  downloadBox.style.display = 'block';
  downloadMessage.textContent = 'Your download link (one-time use)';
}

async function createCheckoutAndOpen(product){
  try{
    modalStatus.textContent='Creating checkout...';
    const res = await fetch(`${SERVER_URL}/create-checkout`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({product})
    });
    if(!res.ok){ modalStatus.textContent='Failed to create checkout'; return; }
    const data = await res.json();
    if(!data || !data.checkoutUrl){ modalStatus.textContent='Invalid server response'; return; }
    openCheckoutModal(data.checkoutUrl);
    startPolling(product);
  }catch(err){
    console.error(err);
    modalStatus.textContent='Error creating checkout';
  }
}

buyButtons.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const product = btn.getAttribute('data-product');
    downloadBox.style.display='none';
    downloadUrl.href='#';
    downloadUrl.textContent='';
    createCheckoutAndOpen(product);
  });
});
</script>

</body>
</html>
